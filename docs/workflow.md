# Workflow

本文档描述 `src/main.js` 在 `--mode=backtest` 下的端到端处理流程（从读取 CSV → 选股 → 下单 → 生成组合报告）。

## 入口与目录约定

- 入口脚本：`src/main.js`
- 数据目录：默认项目根目录下的 `stock/`（可用 `--data-dir` 指定；读取目录下 `*.csv`）
- 输出：项目根目录生成 `量化分析结果+YYYY_MM_DD_HH_mm_ss.html`（北京时间）

## 回测流程（周期轮动，组合口径）

backtest 模式只输出“组合口径”结果：一份资金池从头跑到尾。

### 1) 枚举与解析（逐文件）

- 读取 `stock/` 下所有 `.csv` 文件名并排序（保证顺序可复现）
- 可选：`--files=...` 仅跑指定文件；`--limit=...` 仅跑前 N 个文件
- 逐文件读取：按 `--encoding` 解码（默认 `GBK`；`auto` 仅做 BOM 级别识别后回退 `GBK`）
- 用 `csv-parse` 解析成记录数组，并校验必须列存在：
  - `股票名称`（用于排除 ST）
  - `交易日期`
  - `收盘价_复权`（用于均线与成交价）

### 2) 切分交易周期（买卖日）

- 把“全市场出现过的交易日期”去重后得到市场交易日历（近似）
- 根据 `--freq=D|W|M|Q` 切分自然周期，并为每个周期确定：
  - 买入日 `buy_ymd`：该周期第一个交易日
  - 卖出日 `sell_ymd`：该周期最后一个交易日
- 日频（`freq=D`）是隔夜：`buy_ymd=t`，`sell_ymd=下一交易日`
- 若某个周期只有 1 个交易日（`buy_ymd==sell_ymd`），该周期跳过（避免同日买卖）

### 3) 策略选股（strategy.js）

- 默认从项目根目录读取 `strategy.js`（可用 `--strategy-file=PATH` 指定）
- 策略文件必须导出 `strategy(ctx)`，返回本周期要买的股票 `file` 列表（如 `sh600000.csv`）
- 策略接口与口径说明：见 `STRATEGY_API.md`
- 为避免未来函数：引擎会给策略一个 `asOfYmd`（买入日前一交易日），策略只能用这一天及更早的数据产生信号
- `--pick-limit=N` 会在引擎层面对返回结果再截断一次（策略层也可以自行控制）

### 4) 组合资金执行（均仓买入，周期末全卖）

- 初始资金池：`--capital`（默认 100w）
- 买入日：对当周期入选股票按现金等权分配买入（收盘价_复权）
- 卖出日：当周期持仓全部卖出（收盘价_复权）
- 缺价处理：若某票在买入日或卖出日缺少复权收盘价（NaN/<=0/不存在该日记录），该票该周期整期跳过（不建仓）
- 理想化成交：不考虑涨跌停/停牌导致的成交失败；不限制整手/最小成交单位（可无限可分）
- 成本：佣金 `--fee-bps`（双边）与印花税 `--stamp-bps`（卖出）

### 5) 输出报告

- Strategy Summary：组合期末资金/收益/最大回撤/交易次数/胜率 + 周期统计
- 组合资金曲线：区间内每日盯市的净值曲线（支持 hover tooltip）

## 性能与风险点

- 全量数据下 I/O 与 CSV 解析是主要耗时；`--files` / `--limit` 可用于快速验证
- CSV 行顺序会影响均线与日期定位；**每个 CSV 必须按 `交易日期` 升序排列**，否则结果不可信

