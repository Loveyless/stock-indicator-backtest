# STRATEGY：指标编写与校验

目的：把“指标公式”（REF / SUM / MA / EMA…）落到本仓库可用、可维护的 JavaScript 实现口径，避免因为实现细节不一致导致回测结果失真。

## 先说结论：你贴的说明有用，但有几处是错的

以下内容**概念上有用**（REF/滚动窗口/均线/条件选择等），但你贴的“pandas 写法”里存在明显误导：

- `IF(COND, A, B)` 的示例只给满足条件的行赋值，**否则分支会留空/NaN**；正确做法应当一次性覆盖两边（例如 numpy 的 `where` 思路），或两次赋值。
- `SUM(成交量, 10)` 的示例文字写“10日收盘价总和”，但代码是成交量 rolling sum —— **描述/字段对不上**（实现没问题，文案错）。
- `SMA(X,N,M)`（通达信/同花顺口径的 SMA）你贴的 `ewm(span=(10-3))` **不是同一个东西**；SMA 是递推公式（见下）。
- `WMA(X,N)` 你贴的 `rolling.apply(lambda ...)` **不等价**于权重 1..N 的加权平均（公式/分母都不对）。
- `DMA(X,a)` 你贴的 `a=10` **不合法**（`a` 应在 `[0,1]` 或是一列动态系数）；而且递推应使用上一期的 `DMA`，不是 `REF(X,1)`（见下）。

如果把这些错实现带进回测，结果会“看起来能跑”，但指标数值本质不对，等于白测。

## 本仓库的数据口径（你写策略前必须对齐）

### 当前最小数据契约

见 `docs/data-contract.md`：`src/main.js` 读取 CSV 时**要求至少**有：

- `股票名称`（用于排除 ST）
- `交易日期`
- `收盘价_复权`（当前策略用它做均线与成交价）

当前默认示例策略 `strategy.js` 只依赖 `交易日期 + 收盘价_复权 + 股票名称`。

### 指标运算的基本约定（强烈建议）

在本项目里，更稳的写法是把每只股票的数据当成**等长数组**（同一 index 对应同一天）：

- `dates[i]`：`YYYYMMDD`（整型/字符串都可，但要一致）
- `x[i]`：指标序列（`Number`，缺失用 `NaN`）

指标函数的约定：

- **逐元素**运算：`+ - * /` 都是 element-wise。
- **历史引用/滚动窗口**：不够 N 天的地方返回 `NaN`（不要硬填 0，不然会污染条件判断）。
- 条件表达式 `COND` 也是一列布尔值（长度一致）。

## 指标函数：推荐的“可落地”实现口径

下面是口径说明（不是要求你现在就做解析器/DSL；先把语义统一）。

### 1) REF(X, N)

语义：取 N 天前的值。

- `REF(x, 0) === x`
- `REF(x, N)` 的前 N 个位置输出 `NaN`

### 2) IF(COND, A, B)

语义：逐元素选择：

- `out[i] = COND[i] ? A[i] : B[i]`
- `A/B` 可以是序列，也可以是常数（常数视为广播到整列）

### 3) SUM(X, N) / MAX(X, N) / MIN(X, N) / MA(X, N)

都属于“过去 N 天滚动窗口”：

- 输出长度与输入相同
- `i < N-1` 的位置输出 `NaN`
- 窗口定义：`[i-N+1, ..., i]`（包含当天）

其中：

- `MA(X,N) = SUM(X,N) / N`

### 4) EMA(X, N)

语义：指数移动平均（常见技术分析口径）：

- `alpha = 2 / (N + 1)`
- `EMA[i] = alpha * X[i] + (1 - alpha) * EMA[i-1]`

初始化口径要写清楚（否则会对前 N 天有偏差）：

- 常用做法：`EMA[0] = X[0]`（若 `X[0]` 是 NaN，则往后找第一个非 NaN 作为起点）

### 5) SMA(X, N, M)（A 股软件常见“递推 SMA”）

通达信/同花顺口径的 SMA 不是普通 `MA`，而是递推：

- `SMA[i] = (M * X[i] + (N - M) * SMA[i-1]) / N`
- 其中 `N > 0`，`0 < M <= N`

要点：

- 这不是 `pandas ewm` 的某个参数能直接等价替代的东西。
- 初始化一般取 `SMA[0] = X[0]`（或首个有效值）。

### 6) WMA(X, N)

语义：加权移动平均。常见口径是“越近权重越大”：

- 权重：`1, 2, ..., N`（最近一天权重 N）
- `WMA[i] = SUM_{k=0..N-1} (X[i-k] * (N-k)) / SUM_{w=1..N} w`

分母：`N * (N + 1) / 2`

### 7) DMA(X, a)

语义：动态移动平均（本质是 EMA 的 alpha 变成动态系数）：

- `DMA[i] = a[i] * X[i] + (1 - a[i]) * DMA[i-1]`

要点（你贴的示例错在这里）：

- `a` 必须在 `[0,1]`（常数或一列动态系数）
- 递推用的是上一期 `DMA`，不是上一期 `X`

## 策略开发者最容易踩的坑（建议你写进策略 README 的那种）

- **行顺序必须按日期升序**：`docs/data-contract.md` 已明确；乱序会让 `REF/MA/EMA` 全部失真。
- **缺失值别瞎补 0**：技术指标里 0 往往是强信号，会把 IF 条件/阈值判断搞炸。
- **初始化口径要固定**：尤其 EMA/SMA/DMA；否则同一公式不同实现跑出来完全不同。
- **用复权价还是不复权价**：当前默认用 `收盘价_复权`；换成不复权会让“趋势类指标”完全变味。

## 在本仓库里怎么落地（不搞过度设计版）

推荐路径：

1) 优先复用本仓库提供的指标函数：`src/indicators.js`（数组 → 数组）。
2) 不够用时，再在策略文件里补“明确的指标函数”（普通 JS 函数处理数组）。
3) 指标函数只做一件事：输入数组 → 输出数组；不要在里面读文件/做交易逻辑。
4) 策略只拿“信号截止日(asOfYmd)及更早”的指标结果做选股，避免未来函数（接口见 `STRATEGY_API.md`）。

对照示例：

- 示例策略文件：`strategy.js`（多头排列 MA，按 `asOfYmd` 计算信号）

如果你后续真的要让用户“写公式字符串”，再考虑引入 DSL/解析器；现在做这个只会把项目搞复杂、变脆。
